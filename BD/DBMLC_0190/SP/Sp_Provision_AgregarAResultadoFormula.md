# Stored Procedure: Sp_Provision_AgregarAResultadoFormula

## Usa los objetos:
- [[Provision_OT_Acumulado]]
- [[Provision_OT_Compania]]
- [[Provision_OT_Cuentas]]
- [[Provision_OT_Datos]]
- [[Provision_OT_Formula]]
- [[Provision_OT_Resultado]]

```sql

CREATE PROCEDURE Sp_Provision_AgregarAResultadoFormula

@FECHAREVISION DATETIME,
@empresa int

AS
BEGIN
	--NO IMPRIME RESULTADOS AUTOMATICOS
	SET NOCOUNT ON

	DECLARE
	--VARIABLES PARA CURSOR
	@MONTH INT,
	@YEAR INT,
	@VALOR DECIMAL(18,16),
	@IDEMPRESA SMALLINT,
	@IDCENTRO SMALLINT,
	@IDSECCION INT,
	@IDMARCA SMALLINT,
	@TOTALMES DECIMAL(18,6),
	@ACUMULADO DECIMAL(18,6),
	@PROVISION DECIMAL(18,6),
	@DEPARTAMENTO NVARCHAR(255),

	--DETECCION DE LAS CUENTAS SEGUN NATURALEZA
	@CTABALANCE NVARCHAR(255),
	@CTAINGRESO NVARCHAR(255),
	@CTAGASTO NVARCHAR(255),
	@A SMALLINT,
	@CUENTA NVARCHAR(255),
	@NATURALEZA NVARCHAR(255)

	SET @CTABALANCE = (	SELECT	C.Numero 
						FROM	Provision_OT_Cuentas C 
						WHERE	C.Estado = 1
						GROUP BY C.Numero 
						HAVING COUNT(C.Numero) > 1 )

	PRINT 'CUENTA BALANCE: ' + CONVERT(NVARCHAR(255), @CTABALANCE)

	SET @CTAINGRESO = (	SELECT	C.Numero 
						FROM	Provision_OT_Cuentas C
						WHERE	C.Numero <> @CTABALANCE AND 
								C.Naturaleza <> 'INGRESO' AND
								C.Estado = 1 )

	PRINT 'CUENTA INGRESO: ' + CONVERT(NVARCHAR(255), @CTAINGRESO)

	SET @CTAGASTO = (	SELECT	C.Numero 
						FROM	Provision_OT_Cuentas C
						WHERE	C.Numero <> @CTABALANCE AND 
								C.Naturaleza <> 'GASTO' AND
								C.Estado = 1 )

	PRINT 'CUENTA GASTO: ' + CONVERT(NVARCHAR(255), @CTAGASTO)

	--VALIDACION DE LAS CUENTAS PARA LA PROVISION
	IF 
	(
		@CTABALANCE IS NOT NULL AND @CTAGASTO IS NOT NULL AND @CTAINGRESO IS NOT NULL
	) 
	BEGIN
		SET @MONTH = MONTH(@FECHAREVISION)
		SET @YEAR = YEAR(@FECHAREVISION)

		SET @VALOR = (SELECT F.Total 
						FROM Provision_OT_Formula F
						WHERE F.IdFormula = @MONTH)
		
		PRINT ''
		PRINT @FECHAREVISION
		PRINT ''
		PRINT 'VALOR PARA CALCULO: ' + CONVERT(VARCHAR(18), @VALOR)
		PRINT ''

		--RESTAR UN MES A LA FECHA DE REVISION PARA EL ACUMULADO
		IF (@MONTH = 1)
		BEGIN
			SET @YEAR -= 1
			SET @MONTH = 12
		END
		ELSE
		BEGIN
			SET @MONTH -= 1;
		END

		--LIMPIAR ACUMULADO EXISTENTE DEL MES QUE SE PROVISIONA
		DELETE	
		FROM	Provision_OT_Acumulado 
		WHERE	(Fecha = @FECHAREVISION AND
				Fecha <> '20191031') AND 
				IdEmpresa = @empresa

		--DECLARAR CURSOR CON CONSULTA...
		DECLARE CursorTemporal CURSOR FOR 

		--CONSULTA DEL CURSOR QUE AGRUPA POR (CENTRO, SECCION Y MARCA)* 
		--TRAE PARA ESTA* AGRUPACION SUMA DE OTS 
		--MULTIPLICA ESA SUMA POR EL VALOR DE LA FORMULA SEGUN MES EN Provision_OT_Formula 
		--Y REDONDEA EL RESULTADO SIN DECIMALES; EL RESULTADO LO COLOCA EN LA COLUMNA TOTAL
		SELECT C.IdCompania, D.IdCentro, D.IdSeccion, D.IdMarca, D.Seccion,
				Total = CONVERT(DECIMAL(18,0),(SUM(D.VrCosteRep + D.VrCosteSub) * @VALOR))
		FROM Provision_OT_Datos D, Provision_OT_Compania C
		WHERE D.IdProvisionCompania = C.IdCompania AND C.Calculo = 'FORMULA'
		GROUP BY C.IdCompania, D.IdCentro, D.IdSeccion, D.IdMarca, D.Seccion 
		ORDER BY C.IdCompania, D.IdCentro, D.IdSeccion, D.IdMarca 

		--APERTURA DE CURSOR
		OPEN CursorTemporal

		--CARGAR CURSOR EN VARIABLES
		FETCH NEXT FROM CursorTemporal INTO @IDEMPRESA, @IDCENTRO, @IDSECCION, @IDMARCA, @DEPARTAMENTO, @TOTALMES

		WHILE(@@FETCH_STATUS = 0)
		BEGIN

		PRINT ''
		--VALIDACION DE CAPTURA DE DATOS EN VARIABLES
		PRINT CONVERT(NVARCHAR(255),@IDCENTRO) + ' - ' + CONVERT(NVARCHAR(255),@IDSECCION) + ' - ' + CONVERT(NVARCHAR(255),@IDMARCA)

		--CARGAR EL VALOR DE LA PROVISION ACUMULADA
		SET @ACUMULADO = (	SELECT	A.VrAcumulado 
							FROM	Provision_OT_Acumulado A
							WHERE	A.IdCentro = @IDCENTRO AND A.IdSeccion = @IDSECCION AND 
									A.IdMarca = @IDMARCA AND MONTH(A.Fecha) = @MONTH AND YEAR(A.Fecha) = @YEAR )

		--SI NO HAY ACUMULADO PONE 0
		IF(@ACUMULADO IS NULL) SET @ACUMULADO = 0

		--IMPRIME LOS RESULTADOS DE LA PROVISION
		PRINT 'ACUMULADO: ' + CONVERT(VARCHAR(20), @ACUMULADO)
		PRINT 'TOTAL: ' + CONVERT(VARCHAR(20), @TOTALMES)

		--CARGA LA PROVISION RESTANDO EL MES CON EL ACUMULADO
		SET @PROVISION = @TOTALMES - @ACUMULADO
		PRINT 'PROVISION: ' + CONVERT(VARCHAR(20), @PROVISION)
		PRINT ''

		--INSERTAR PROVISION DE FORMULA EN TABLA Provision_OT_Acumulado
		IF NOT EXISTS 
		(
			SELECT	A.VrAcumulado 
			FROM	Provision_OT_Acumulado A
			WHERE	A.IdCentro = @IDCENTRO AND A.IdSeccion = @IDSECCION AND 
					A.IdMarca = @IDMARCA AND A.Fecha = @FECHAREVISION
		)
		BEGIN
			INSERT INTO Provision_OT_Acumulado
			(
				IdEmpresa, IdCentro, IdSeccion, IdMarca, VrAcumulado, Fecha
			)
			VALUES
			(
				@IDEMPRESA, @IDCENTRO, @IDSECCION, @IDMARCA, @TOTALMES, @FECHAREVISION
			)
		END
		
		--CICLO PARA AGREGAR REGISTRO DE LA PROVISION Y DEL BALANCE
		SET @A = 0

		WHILE(@A <= 1)--INICIO DEL CICLO PARA REGISTRO DE PROVISION Y BALANCE
		BEGIN
			PRINT '=> UNA VUELTA'

			IF(@A = 0)--INICIO A = 0
			BEGIN
				PRINT 'CUENTA DE LA PROVISION'
				IF(	@PROVISION < 0)--INICIO PROVISION < 0
				BEGIN
					SET @CUENTA = @CTAGASTO
					SET @NATURALEZA = 'H'

					PRINT 'CUENTA + GASTO'
				END--FIN PROVISION < 0
				ELSE--INICIO PROVISION > 0
				BEGIN
					SET @CUENTA = @CTAINGRESO
					SET @NATURALEZA = 'D'

					PRINT 'CUENTA + INGRESO'
				END--FIN PROVISION > 0
			END--FIN A = 0
			ELSE--INICIO A = 1
			BEGIN
				PRINT 'CUENTA DE BALANCE'
				IF(@NATURALEZA = 'D')--INICIO NATURALEZA = INGRESO
				BEGIN
					SET @CUENTA = @CTABALANCE
					SET @NATURALEZA = 'H'
					PRINT 'CUENTA BALANCE + GASTO'
				END--FIN NATURALEZA = INGRESO
				ELSE--INICIO NATURALEZA = GASTO
				BEGIN
					SET @CUENTA = @CTABALANCE
					SET @NATURALEZA = 'D'
					PRINT 'CUENTA BALANCE + INGRESO'
				END--FIN NATURALEZA = GASTO
			END--FIN A = 1

			--INSERTAR DATOS EN Provision_OT_Resultado
			INSERT INTO Provision_OT_Resultado
			(
				IdEmpresa, IdCentro, IdSeccion, IdMarca, Departamento, VrAcumulado, VrActual, VrProvision, Fecha, Cuentas, Naturaleza
			)
			VALUES
			(
				@IDEMPRESA, @IDCENTRO, @IDSECCION, @IDMARCA, @DEPARTAMENTO, @ACUMULADO, @TOTALMES, @PROVISION, @FECHAREVISION, @CUENTA, @NATURALEZA
			)
			SET @A += 1--INCREMENTAR CICLO
		END--FIN DEL CICLO PARA RESGISTRO DE PROVISION Y BALANCE
		
		--CARGAR CURSOR EN VARIABLES PARA EL CICLO
		FETCH NEXT FROM CursorTemporal INTO @IDEMPRESA, @IDCENTRO, @IDSECCION, @IDMARCA, @DEPARTAMENTO, @TOTALMES
		END

		--CIERRA EL CURSOR
		CLOSE CursorTemporal

		--ELIMINA EL CURSOR
		DEALLOCATE CursorTemporal

	END

	ELSE
	BEGIN
		PRINT 'NO ESTAN LAS CUENTAS PARAMETRIZADAS ADECUADAMENTE PARA LA PROVISION'
	END

	--IMPRIME RESULTADOS AUTOMATICOS
	SET NOCOUNT OFF

END
```
